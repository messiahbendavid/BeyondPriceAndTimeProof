<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proof of the Law of Novelty</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#050508;--surface:#0a0a14;--card:#12122a;--border:rgba(0,255,136,0.15);
            --green:#00ff88;--cyan:#00ffff;--gold:#ffd700;--red:#ff4444;
            --text:#e0e0e0;--muted:#888;
            --ft:'Orbitron',sans-serif;--fm:'Roboto Mono',monospace;--fb:'Inter',sans-serif}
        html{scroll-behavior:smooth}
        body{background:var(--bg);color:var(--text);font-family:var(--fb);line-height:1.7}
        nav{position:fixed;top:0;left:0;right:0;z-index:1000;background:rgba(5,5,8,0.92);
            backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:12px 40px;
            display:flex;align-items:center;justify-content:space-between}
        nav .logo{font-family:var(--ft);font-size:13px;font-weight:700;letter-spacing:3px;color:var(--green)}
        nav a{font-family:var(--fm);font-size:10px;color:var(--muted);text-decoration:none;letter-spacing:1px;margin-left:20px}
        nav a:hover{color:var(--green)}
        section{padding:80px 40px;max-width:1200px;margin:0 auto}
        .sl{font-family:var(--fm);font-size:10px;letter-spacing:4px;text-transform:uppercase;margin-bottom:12px;color:var(--gold)}
        .st{font-family:var(--ft);font-size:clamp(22px,3vw,36px);font-weight:700;letter-spacing:3px;margin-bottom:24px;color:#fff}
        .sb{font-size:15px;color:#aaa;max-width:800px;line-height:1.9}
        .sb p{margin-bottom:16px}
        .hl{color:var(--green);font-weight:500}
        .hero{min-height:60vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:120px 40px 60px}
        .hero-badge{font-family:var(--fm);font-size:10px;letter-spacing:4px;color:var(--gold);border:1px solid rgba(255,215,0,0.3);padding:6px 18px;border-radius:20px;margin-bottom:30px}
        .hero h1{font-family:var(--ft);font-size:clamp(26px,4vw,48px);font-weight:900;letter-spacing:5px;line-height:1.2;margin-bottom:16px}
        .hero h1 .g{color:var(--green)}.hero h1 .c{color:var(--cyan)}.hero h1 .r{color:var(--red)}
        .hero-sub{font-family:var(--fm);font-size:12px;color:var(--muted);max-width:700px;letter-spacing:1px;margin-bottom:24px}
        .hbox{background:linear-gradient(135deg,rgba(18,18,42,0.9),rgba(10,10,18,0.95));border:1px solid var(--border);border-radius:12px;padding:28px;margin:20px 0;position:relative;overflow:hidden}
        .hbox::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:linear-gradient(180deg,var(--green),var(--cyan),var(--gold))}
        .hbox .hl-label{font-family:var(--ft);font-size:10px;color:var(--gold);letter-spacing:3px;margin-bottom:8px}
        .hbox .hl-text{font-size:16px;color:#fff;font-weight:500;line-height:1.6}
        .hbox .hl-sub{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.7}
        .upload-zone{border:2px dashed rgba(0,255,136,0.3);border-radius:12px;padding:36px;text-align:center;margin:20px 0;transition:all 0.2s;background:rgba(0,255,136,0.02);cursor:pointer;position:relative}
        .upload-zone:hover,.upload-zone.dragover{border-color:var(--green);background:rgba(0,255,136,0.06)}
        .upload-zone .icon{font-size:32px;margin-bottom:8px}
        .upload-zone .label{font-family:var(--ft);font-size:11px;color:var(--green);letter-spacing:2px;margin-bottom:4px}
        .upload-zone .hint{font-size:11px;color:var(--muted)}
        .upload-zone input[type="file"]{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer}
        .srow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
        .srow label{font-family:var(--fm);font-size:10px;color:var(--muted);letter-spacing:1px}
        .srow input[type="text"]{background:var(--card);border:1px solid #333;color:#fff;padding:5px 10px;border-radius:5px;font-family:var(--fm);font-size:10px}
        .btn-p{font-family:var(--ft);font-size:11px;letter-spacing:2px;padding:10px 22px;background:linear-gradient(135deg,#00aa44,var(--green));color:#000;border:none;border-radius:6px;cursor:pointer;font-weight:700;transition:all 0.2s}
        .btn-p:hover{transform:scale(1.03);box-shadow:0 0 15px rgba(0,255,136,0.3)}
        .btn-p:disabled{opacity:0.4;cursor:not-allowed;transform:none}
        .btn-s{font-family:var(--fm);font-size:10px;padding:7px 14px;background:var(--card);color:var(--cyan);border:1px solid var(--cyan);border-radius:5px;cursor:pointer}
        .btn-s:hover{background:rgba(0,255,255,0.1)}
        .pbar{width:100%;height:6px;background:#1a1a2e;border-radius:3px;overflow:hidden;margin:10px 0;display:none}
        .pbar.active{display:block}
        .pbar .fill{height:100%;width:0%;background:linear-gradient(90deg,var(--green),var(--cyan));border-radius:3px;transition:width 0.15s}
        .flist{margin:8px 0;max-height:200px;overflow-y:auto}
        .fitem{display:flex;align-items:center;justify-content:space-between;padding:4px 10px;background:rgba(18,18,42,0.6);border:1px solid #222;border-radius:4px;margin:2px 0;font-family:var(--fm);font-size:10px;color:#aaa}
        .fitem .rm{color:var(--red);cursor:pointer;padding:2px 6px}
        .fcount{font-family:var(--fm);font-size:11px;color:var(--cyan);margin:6px 0}
        .smsg{font-family:var(--fm);font-size:10px;color:var(--muted);margin:6px 0;min-height:14px}
        .err-msg{font-family:var(--fm);font-size:10px;color:var(--red);margin:4px 0;padding:8px;background:rgba(255,68,68,0.08);border:1px solid rgba(255,68,68,0.2);border-radius:4px;display:none}
        .pr-container{max-height:200px;overflow-y:auto;margin:6px 0}
        .pr{background:var(--card);border:1px solid #333;border-radius:8px;padding:10px;margin:4px 0;font-family:var(--fm);font-size:10px}
        .pr .prt{color:var(--cyan);font-weight:600;font-size:11px}
        .pr .prw{color:var(--gold)}.pr .pre{color:var(--red)}.pr .pro{color:var(--green)}
        .rc{display:none}.rc.vis{display:block}
        .vbox{text-align:center;padding:24px;background:linear-gradient(135deg,var(--card),var(--surface));border-radius:12px;margin:24px 0;border:2px solid var(--green)}
        .vbox .vl{font-family:var(--fm);font-size:10px;letter-spacing:3px;color:var(--gold);margin-bottom:4px}
        .vbox .vv{font-family:var(--ft);font-size:22px;font-weight:800;letter-spacing:3px;margin-bottom:4px}
        .vbox .vd{font-family:var(--fm);font-size:11px;color:var(--muted)}
        .stat-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:20px 0}
        .stat-card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:20px;text-align:center}
        .stat-card .stat-val{font-family:var(--ft);font-size:28px;font-weight:800;margin:8px 0}
        .stat-card .stat-label{font-family:var(--fm);font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase}
        .stat-card .stat-sub{font-family:var(--fm);font-size:10px;color:#666;margin-top:4px}
        .fcb{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:16px;margin:16px 0}
        .ct{font-family:var(--ft);font-size:10px;color:var(--cyan);letter-spacing:2px;margin-bottom:10px}
        .ct-sub{font-family:var(--fm);font-size:10px;color:#555;margin-bottom:10px;line-height:1.5}
        .csw{width:100%;overflow-x:auto}
        .stbl-wrap{max-height:500px;overflow-y:auto}
        .stbl{width:100%;border-collapse:collapse;font-family:var(--fm);font-size:10px;margin:12px 0}
        .stbl th{background:var(--card);color:var(--green);padding:6px 8px;text-align:left;letter-spacing:1px;border-bottom:1px solid var(--border);font-size:9px;position:sticky;top:0;z-index:1}
        .stbl td{padding:5px 8px;border-bottom:1px solid rgba(255,255,255,0.03);color:#bbb}
        .stbl tr:hover td{background:rgba(0,255,136,0.03)}
        .sg{color:var(--green);font-weight:600}.sr{color:var(--red)}.sw{color:var(--gold)}
        footer{text-align:center;padding:30px;border-top:1px solid rgba(255,255,255,0.04)}
        footer .lf{font-family:var(--ft);font-size:11px;color:var(--green);letter-spacing:3px;margin-bottom:6px}
        footer .cp{font-family:var(--fm);font-size:9px;color:#333;letter-spacing:2px}
        .fi{opacity:0;transform:translateY(20px);transition:opacity 0.6s,transform 0.6s}.fi.vis{opacity:1;transform:translateY(0)}
        @media(max-width:768px){nav{padding:10px 16px}section{padding:50px 16px}.stat-row{grid-template-columns:1fr 1fr}}
        ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:#111}::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
    </style>
</head>
<body>
<nav><div class="logo">PROOF OF THE LAW</div><div><a href="#hypothesis">HYPOTHESIS</a><a href="#test-it">TEST IT</a><a href="#results-section">RESULTS</a></div></nav>

<section class="hero">
    <div class="hero-badge">EMPIRICAL PROOF</div>
    <h1><span class="g">PROVING</span> THE <span class="c">LAW OF</span> <span class="r">NOVELTY</span></h1>
    <p class="hero-sub">If markets were random, each step loses exactly 50%. Upload your data. See where it doesn't.</p>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
        <a href="#test-it"><button class="btn-p">TEST IT YOURSELF</button></a>
        <button class="btn-s" onclick="runDemo()">RUN DEMO</button>
    </div>
</section>

<section id="hypothesis" class="fi">
    <div class="sl">THE HYPOTHESIS</div>
    <h2 class="st">THE 50% DECAY TEST</h2>
    <div class="hbox"><div class="hl-label">NULL HYPOTHESIS (H0)</div><div class="hl-text">Markets are random. Each stasis length should have exactly half the count of the previous. Every step halves.</div></div>
    <div class="hbox"><div class="hl-label">ALTERNATIVE (H1)</div><div class="hl-text">Markets are NOT random. Decay is NOT 50%. Stasis persists longer than randomness allows.</div>
        <div class="hl-sub">The gap is <strong style="color:var(--green)">alpha</strong>. When the count hits 0, <strong style="color:var(--red)">novelty has prevailed</strong>.</div></div>
</section>

<section id="test-it" class="fi">
    <div class="sl">YOUR TURN</div>
    <h2 class="st">TEST IT YOURSELF</h2>
    <div class="sb" style="margin-bottom:16px"><p>Upload up to <span class="hl">150 CSV files</span>. Each uploaded individually for reliability.</p></div>
    <div class="upload-zone" id="uploadZone">
        <div class="icon">&#128194;</div>
        <div class="label">DROP CSV FILES HERE (UP TO 150)</div>
        <div class="hint">CSV/TSV with date + price columns</div>
        <input type="file" id="fileInput" multiple accept=".csv,.tsv,.txt,.dat">
    </div>
    <div class="fcount" id="fileCount"></div>
    <div class="flist" id="fileList"></div>
    <div class="err-msg" id="errMsg"></div>
    <div class="pr-container" id="parseReports"></div>
    <div class="srow"><label>THRESHOLDS:</label><input type="text" id="thresholdsInput" value="0.005, 0.0075, 0.01, 0.015, 0.02, 0.025, 0.03, 0.04, 0.05" style="width:440px"></div>
    <div style="display:flex;gap:8px;margin:14px 0;flex-wrap:wrap">
        <button class="btn-p" id="runBtn" onclick="runAnalysis()" disabled>RUN ANALYSIS</button>
        <button class="btn-s" onclick="runDemo()">DEMO</button>
        <button class="btn-s" onclick="clearAll()">CLEAR</button>
    </div>
    <div class="pbar" id="pbar"><div class="fill" id="pfill"></div></div>
    <div class="smsg" id="smsg">Upload CSV files to begin</div>
</section>

<section id="results-section">
    <div class="rc" id="rc">
        <div class="sl">RESULTS</div>
        <h2 class="st" id="rTitle">ANALYSIS COMPLETE</h2>
        <div class="vbox" id="vbox"><div class="vl">VERDICT</div><div class="vv" id="vv">-</div><div class="vd" id="vd">-</div></div>
        <div class="stat-row" id="statCards"></div>
        <div class="fcb" id="bitsInfo"></div>
        <div class="fcb">
            <div class="ct">STASIS PATTERN LENGTH vs OCCURRENCES (DUAL AXIS)</div>
            <div class="ct-sub">Left axis = count. Right axis = % of previous length (gold). Red dashed = 50% baseline (from L3). When gold hits 0% = <strong style="color:var(--red)">novelty prevails</strong>.</div>
            <div class="csw" id="mainChart"></div>
        </div>
        <div class="fcb"><div class="ct">% DIFFERENCE: REAL vs RANDOM</div><div class="ct-sub">Excess or deficit at each length vs 50% decay.</div><div class="csw" id="pctDiffChart"></div></div>
        <div class="fcb"><div class="ct">ALPHA: STD DEVS FROM RANDOM</div><div class="ct-sub">Beyond +/-2 sigma = significant.</div><div class="csw" id="alphaChart"></div></div>
        <div class="fcb"><div class="ct">PER-FILE BREAKDOWN</div><div class="stbl-wrap" id="fileTable"></div></div>
        <div class="fcb"><div class="ct">RAW PATTERN COUNTS</div><div id="rawTable"></div></div>
    </div>
</section>

<footer><div class="lf">BEYOND PRICE AND TIME</div><div class="cp">&copy; 2026 TRUTH COMMUNICATIONS LLC</div></footer>

<script>
var uploadedFiles=[], MAX_FILES=150;
function $(id){return document.getElementById(id);}
var FI=$('fileInput'),FL=$('fileList'),FC=$('fileCount'),RB=$('runBtn'),SM=$('smsg'),PB=$('pbar'),PF=$('pfill'),EM=$('errMsg');

FI.addEventListener('change',function(){if(this.files&&this.files.length>0)addFiles(Array.from(this.files));this.value='';});
$('uploadZone').addEventListener('dragover',function(e){e.preventDefault();e.stopPropagation();this.classList.add('dragover');});
$('uploadZone').addEventListener('dragleave',function(e){e.preventDefault();e.stopPropagation();this.classList.remove('dragover');});
$('uploadZone').addEventListener('drop',function(e){e.preventDefault();e.stopPropagation();this.classList.remove('dragover');if(e.dataTransfer.files)addFiles(Array.from(e.dataTransfer.files));});

function showErr(m){EM.textContent=m;EM.style.display=m?'block':'none';}
function setStat(m,c){SM.textContent=m;SM.style.color=c||'#888';}

function addFiles(files){showErr('');for(var i=0;i<files.length;i++){if(uploadedFiles.length>=MAX_FILES){showErr('Max '+MAX_FILES);break;}
var f=files[i];if(f.size===0||f.size>50*1048576)continue;var dup=false;for(var j=0;j<uploadedFiles.length;j++)if(uploadedFiles[j].name===f.name&&uploadedFiles[j].size===f.size){dup=true;break;}
if(!dup)uploadedFiles.push(f);}renderFL();RB.disabled=!uploadedFiles.length;if(uploadedFiles.length)setStat(uploadedFiles.length+' file(s) ready','#00ff88');}

function renderFL(){var tot=0;for(var i=0;i<uploadedFiles.length;i++)tot+=uploadedFiles[i].size;
FC.textContent=uploadedFiles.length?uploadedFiles.length+'/'+MAX_FILES+' files ('+(tot/1048576).toFixed(1)+'MB)':'';FL.innerHTML='';
if(!uploadedFiles.length)return;if(uploadedFiles.length>15){FL.innerHTML='<div class="fitem"><span style="color:var(--cyan)">'+uploadedFiles.length+' files</span><span class="rm" onclick="clearAll()">Clear all</span></div>';
for(var i=0;i<3;i++)FL.innerHTML+='<div class="fitem"><span>'+uploadedFiles[i].name+'</span></div>';
FL.innerHTML+='<div class="fitem"><span style="color:#555">... '+(uploadedFiles.length-6)+' more ...</span></div>';
for(var i=uploadedFiles.length-3;i<uploadedFiles.length;i++)FL.innerHTML+='<div class="fitem"><span>'+uploadedFiles[i].name+'</span></div>';}
else{for(var i=0;i<uploadedFiles.length;i++)FL.innerHTML+='<div class="fitem"><span>'+uploadedFiles[i].name+' ('+(uploadedFiles[i].size/1024).toFixed(1)+'KB)</span><span class="rm" onclick="rmFile('+i+')">x</span></div>';}}
function rmFile(i){uploadedFiles.splice(i,1);renderFL();RB.disabled=!uploadedFiles.length;}
function clearAll(){uploadedFiles=[];renderFL();RB.disabled=true;setStat('Cleared');showErr('');$('parseReports').innerHTML='';$('rc').classList.remove('vis');FC.textContent='';}

function renderPR(reports){var c=$('parseReports');c.innerHTML='';var show=reports.slice(0,12);
for(var i=0;i<show.length;i++){var r=show[i],d=document.createElement('div');d.className='pr';
var h='<div class="prt">'+r.filename+'</div>',np=r.n_parsed||0;
if(r.errors&&r.errors.length)h+='<div class="pre">'+r.errors[0]+'</div>';
else h+='<div class="pro">'+np+' prices | '+(r.price_col||'?')+' | '+(r.price_range||'?')+'</div>';
if(r.warnings)for(var w=0;w<r.warnings.length;w++)h+='<div class="prw">'+r.warnings[w]+'</div>';
d.innerHTML=h;c.appendChild(d);}
if(reports.length>12){var m=document.createElement('div');m.className='pr';m.innerHTML='<div style="color:#555;text-align:center">...and '+(reports.length-12)+' more</div>';c.appendChild(m);}}

async function runAnalysis(){if(!uploadedFiles.length)return;showErr('');RB.disabled=true;PB.classList.add('active');PF.style.width='1%';
try{var h=await fetch('/health');if(!h.ok)throw 0;}catch(e){showErr('Server not reachable');RB.disabled=false;PB.classList.remove('active');return;}
setStat('Creating session...','#ffd700');var sr;try{sr=await(await fetch('/session/create',{method:'POST'})).json();}catch(e){showErr('Session failed');RB.disabled=false;PB.classList.remove('active');return;}
var sid=sr.session_id,total=uploadedFiles.length,up=0,skip=0,fail=0;
for(var i=0;i<total;i++){PF.style.width=((i+1)/(total+1)*80)+'%';setStat('Uploading '+(i+1)+'/'+total+': '+uploadedFiles[i].name,'#ffd700');
var fd=new FormData();fd.append('session_id',sid);fd.append('file',uploadedFiles[i]);
try{var r=await fetch('/session/upload',{method:'POST',body:fd});var d=await r.json();if(d.status==='ok')up++;else if(d.status==='skipped')skip++;else fail++;}catch(e){fail++;}}
setStat('Uploaded '+up+'. Analyzing...','#ffd700');PF.style.width='85%';
try{var r2=await fetch('/session/run',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:sid,thresholds:$('thresholdsInput').value})});
PF.style.width='95%';var d2=await r2.json();if(d2.error){showErr(d2.error);setStat('Error','#ff4444');RB.disabled=false;PB.classList.remove('active');return;}
PF.style.width='100%';if(d2.parse_reports)renderPR(d2.parse_reports);
if(d2.files_analyzed===0){showErr('No files analyzed');setStat('0 analyzed','#ff4444');}
else{var msg=d2.files_analyzed+'/'+d2.files_attempted+' analyzed';if(d2.files_significant)msg+=' | '+d2.files_significant+' significant';
if(skip)msg+=' | '+skip+' skipped';setStat(msg,'#00ff88');render(d2);$('rc').classList.add('vis');$('results-section').scrollIntoView({behavior:'smooth'});}}
catch(e){showErr('Error: '+e.message);setStat('Failed','#ff4444');}
finally{RB.disabled=!uploadedFiles.length;setTimeout(function(){PB.classList.remove('active');},1500);}}

async function runDemo(){showErr('');PB.classList.add('active');PF.style.width='30%';setStat('Demo...','#ffd700');
try{var r=await fetch('/analyze-demo');PF.style.width='90%';var d=await r.json();if(d.error){showErr(d.error);return;}
PF.style.width='100%';setStat('Demo complete','#00ff88');if(d.parse_reports)renderPR(d.parse_reports);render(d);$('rc').classList.add('vis');$('results-section').scrollIntoView({behavior:'smooth'});}
catch(e){showErr('Server error: '+e.message);setStat('Failed','#ff4444');}finally{setTimeout(function(){PB.classList.remove('active');},1500);}}

// SVG
var NS='http://www.w3.org/2000/svg';
function mkS(w,h){var s=document.createElementNS(NS,'svg');s.setAttribute('viewBox','0 0 '+w+' '+h);s.style.width='100%';s.style.minHeight=h+'px';
var b=document.createElementNS(NS,'rect');b.setAttribute('width',w);b.setAttribute('height',h);b.setAttribute('fill','#0a0a14');b.setAttribute('rx','6');s.appendChild(b);return s;}
function mkE(t,a){var e=document.createElementNS(NS,t);for(var k in a)if(a.hasOwnProperty(k))e.setAttribute(k,a[k]);return e;}
function mkT(x,y,t,a){a=a||{};var d={x:x,y:y,fill:'#888','font-family':'Roboto Mono','font-size':'9'};for(var k in a)d[k]=a[k];var e=mkE('text',d);e.textContent=t;return e;}
function fN(n){if(Math.abs(n)>=1e6)return(n/1e6).toFixed(1)+'M';if(Math.abs(n)>=1e3)return(n/1e3).toFixed(1)+'K';if(Math.abs(n)>=100)return Math.round(n)+'';if(n===0)return'0';return n.toFixed(1);}
function nM(v){if(v<=0)return 10;var m=Math.pow(10,Math.floor(Math.log10(v)));var n=v/m;if(n<=1)return m;if(n<=2)return 2*m;if(n<=5)return 5*m;return 10*m;}

function render(data){
    $('rTitle').textContent=data.is_demo?'DEMO: RANDOM WALK':'ANALYSIS: '+data.files_analyzed+' FILE'+(data.files_analyzed>1?'S':'');
    var a=data.aggregate||{};renderVerdict(a,data.is_demo);renderStats(a,data);renderBits(a,data);renderMain(a);renderPctDiff(a);renderAlpha(a);renderFileT(data);renderRawT(a);}

function renderVerdict(a,demo){var vv=$('vv'),vd=$('vd'),vb=$('vbox'),v=a.grand_verdict||'',r=a.grand_alternation_rate||0.5,d=a.grand_deviation_pct||0,p=a.grand_p_value;
if(v.indexOf('NOT_RANDOM')>=0){vv.textContent=v==='STRONGLY_NOT_RANDOM'?'H0 STRONGLY REJECTED':'H0 REJECTED';vv.style.color='#00ff88';vb.style.borderColor='#00ff88';}
else{vv.textContent='NEAR RANDOM (H0 HOLDS)';vv.style.color='#ffd700';vb.style.borderColor='#ffd700';}
vd.textContent='Alt: '+(r*100).toFixed(3)+'% | Dev: '+(d>0?'+':'')+d.toFixed(3)+'% | p='+(p<0.0001?p.toExponential(2):p.toFixed(4))+(demo?' (DEMO)':'');}

function renderStats(a,data){var c=$('statCards'),pd=a.overall_pct_diff||0,b=a.total_bits||0,n=a.n_files||0,p=a.grand_p_value!=null?a.grand_p_value:1,ns=data.files_significant||0;
c.innerHTML='<div class="stat-card"><div class="stat-label">OVERALL % DIFF</div><div class="stat-val" style="color:'+(Math.abs(pd)>5?'#00ff88':Math.abs(pd)>1?'#ffd700':'#888')+'">'+(pd>0?'+':'')+pd.toFixed(1)+'%</div><div class="stat-sub">Real vs Random</div></div>'+
'<div class="stat-card"><div class="stat-label">UNIFIED BITS</div><div class="stat-val" style="color:var(--cyan)">'+b.toLocaleString()+'</div><div class="stat-sub">All thresholds</div></div>'+
'<div class="stat-card"><div class="stat-label">FILES</div><div class="stat-val" style="color:var(--green)">'+n+'</div><div class="stat-sub">'+ns+' significant</div></div>'+
'<div class="stat-card"><div class="stat-label">P-VALUE</div><div class="stat-val" style="color:'+(p<0.01?'#00ff88':p<0.05?'#ffd700':'#888')+'">'+(p<0.0001?p.toExponential(2):p.toFixed(4))+'</div><div class="stat-sub">'+(p<0.01?'Highly significant':p<0.05?'Significant':'Not significant')+'</div></div>';}

function renderBits(a,data){var c=$('bitsInfo'),iv=data.individual_results||[];
var h='<div class="ct">BITSTREAM SUMMARY</div><div style="font-family:var(--fm);font-size:11px;color:#bbb">';
h+='<strong style="color:var(--cyan)">Bits:</strong> '+(a.total_bits||0).toLocaleString()+' | <strong style="color:var(--cyan)">Files:</strong> '+(a.n_files||0);
if(iv.length>0&&iv[0].thresholds_used)h+=' | <strong style="color:var(--cyan)">Thresholds:</strong> '+iv[0].thresholds_used.map(function(t){return t+'%';}).join(', ');
h+='</div>';c.innerHTML=h;}

// ============================================================
// MAIN DUAL-AXIS CHART with SMART LABEL SPACING
// ============================================================
function renderMain(a){
    var c=$('mainChart');c.innerHTML='';
    var rd=a.real_distribution||{},db=a.decay_baseline||{},dp=a.decay_pct||{};
    var ls=[];for(var l=2;l<=30;l++)if(rd[l]!==undefined)ls.push(l);
    if(!ls.length){c.innerHTML='<div style="color:#666;padding:30px;text-align:center">No patterns</div>';return;}

    var W=960,H=540,pL=85,pR=90,pT=50,pB=70;
    var pW=W-pL-pR,pH=H-pT-pB;
    var svg=mkS(W,H);

    svg.appendChild(mkT(W/2,20,'STASIS PATTERN LENGTH vs OCCURRENCES',{fill:'#ffd700','font-family':'Orbitron','font-size':'10','text-anchor':'middle','letter-spacing':'2'}));
    svg.appendChild(mkT(W/2,35,'Green = real | Red dashed = 50% baseline (from L3) | Gold line+dots = % of previous',{fill:'#888','font-size':'8','text-anchor':'middle'}));

    // LEFT Y
    var vals=ls.map(function(l){return Math.max(rd[l]||0,db[l]||0);});
    var maxL=nM(Math.max.apply(null,vals.concat([1])));
    function yL(v){return pT+pH-(Math.min(v,maxL)/maxL)*pH;}

    // RIGHT Y
    var pctVals=[0];for(var i=0;i<ls.length;i++){var pv=dp[ls[i]];if(pv!=null)pctVals.push(pv);}
    var maxR=Math.max(100,Math.max.apply(null,pctVals));maxR=Math.ceil(maxR/10)*10;
    function yR(v){return pT+pH-(Math.min(v,maxR)/maxR)*pH;}
    function xP(i){return pL+((i+0.5)/ls.length)*pW;}

    // Left Y grid
    for(var i=0;i<=5;i++){var y=pT+(pH/5)*i,v=maxL*(1-i/5);
    svg.appendChild(mkE('line',{x1:pL,y1:y,x2:pL+pW,y2:y,stroke:'#1a1a2a','stroke-width':'0.5'}));
    svg.appendChild(mkT(pL-8,y+3,fN(v),{'text-anchor':'end','font-size':'8',fill:'#4a4a6a'}));}
    svg.appendChild(mkT(20,pT+pH/2,'Occurrences',{fill:'#00ff88','font-size':'9','text-anchor':'middle',transform:'rotate(-90 20 '+(pT+pH/2)+')'}));

    // Right Y
    for(var i=0;i<=5;i++){var y=pT+(pH/5)*i,v=maxR*(1-i/5);
    svg.appendChild(mkT(pL+pW+8,y+3,v.toFixed(0)+'%',{'text-anchor':'start','font-size':'8',fill:'#8a7a3a'}));}
    var y50=yR(50);
    svg.appendChild(mkE('line',{x1:pL,y1:y50,x2:pL+pW,y2:y50,stroke:'#ffd700','stroke-width':'1.5','stroke-dasharray':'8 4',opacity:'0.5'}));
    svg.appendChild(mkT(pL+pW+8,y50+3,'50%',{'text-anchor':'start',fill:'#ffd700','font-size':'9','font-weight':'bold'}));
    var y0pct=yR(0);
    svg.appendChild(mkE('line',{x1:pL,y1:y0pct,x2:pL+pW,y2:y0pct,stroke:'#ff4444','stroke-width':'1','stroke-dasharray':'4 2',opacity:'0.3'}));
    svg.appendChild(mkT(W-22,pT+pH/2,'% of previous length',{fill:'#ffd700','font-size':'9','text-anchor':'middle',transform:'rotate(90 '+(W-22)+' '+(pT+pH/2)+')'}));
    svg.appendChild(mkT(pL+pW/2,H-8,'Stasis Pattern Length',{'text-anchor':'middle',fill:'#aaa','font-size':'10'}));

    var barW=Math.max(7,Math.min(22,(pW/ls.length)*0.33)),gap=3,yBot=pT+pH;

    // Determine a "small zone" threshold: bars below this height (in pixels) are "small"
    // We'll use percentage of chart height â€” if bar is less than 8% of chart, it's small
    var smallThreshPx = pH * 0.08;

    // Collect label positions to avoid overlap
    // Each label: { y: pixelY, priority: number }
    // We'll use a simple approach: for small bars, only show labels via tooltip-style offset

    var pctPts=[];

    for(var bi=0;bi<ls.length;bi++){
        var l=ls[bi],x=xP(bi),rv=rd[l]||0,bv=db[l],pv=dp[l];
        var barH = rv > 0 ? (yBot - yL(rv)) : 0;
        var isSmall = barH < smallThreshPx;
        var isZero = rv === 0;

        // GREEN BAR
        if(rv>0){
            var yr=yL(rv);
            svg.appendChild(mkE('rect',{x:x-barW-gap/2,y:yr,width:barW,height:Math.max(yBot-yr,1),fill:'#00ff88',opacity:'0.85',rx:'2'}));

            // Count label: only show above bar if there's room, otherwise skip
            // "Room" means at least 16px between bar top and chart top or previous label
            if(!isSmall || bi < 4) {
                svg.appendChild(mkT(x-barW/2-gap/2,yr-5,fN(rv),{'text-anchor':'middle',fill:'#00ff88','font-size':'7','font-weight':'bold'}));
            }
        } else {
            // Zero marker
            svg.appendChild(mkE('rect',{x:x-barW-gap/2,y:yBot-2,width:barW,height:2,fill:'#00ff88',opacity:'0.4',rx:'1'}));
        }

        // RED BASELINE (L>=3)
        if(bv!=null && l>=3){
            var yb=yL(bv);
            var baseBarH = yBot - yb;
            var baseIsSmall = baseBarH < smallThreshPx;

            svg.appendChild(mkE('rect',{x:x+gap/2,y:yb,width:barW,height:Math.max(yBot-yb,1),fill:'none',stroke:'#ff4444','stroke-width':'2','stroke-dasharray':'4 2',rx:'2',opacity:'0.8'}));

            // Baseline label: only if bar is substantial enough
            if(!baseIsSmall || bi < 4){
                svg.appendChild(mkT(x+barW/2+gap/2,yb-5,fN(bv),{'text-anchor':'middle',fill:'#ff4444','font-size':'7',opacity:'0.7'}));
            }

            // Alpha shading + label only if meaningful gap exists
            if(rv>bv && !isSmall){
                svg.appendChild(mkE('rect',{x:x-barW-gap/2-2,y:yL(rv),width:barW*2+gap+4,height:Math.max(yb-yL(rv),0),fill:'rgba(0,255,136,0.12)',rx:'2'}));
                if(yb-yL(rv) > 14) { // Only show alpha text if gap is tall enough
                    var ap=bv>0?(((rv-bv)/bv)*100).toFixed(0):'?';
                    svg.appendChild(mkT(x,(yL(rv)+yb)/2+3,'+'+ap+'%',{'text-anchor':'middle',fill:'#00ff88','font-size':'7','font-weight':'bold','font-family':'Orbitron'}));
                }
            }
        }

        // Gold pct point
        if(l>=3){
            var pctVal=(pv!=null)?pv:0;
            pctPts.push({x:x,y:yR(pctVal),val:pctVal,l:l,isZero:isZero,bi:bi});
        }

        // X label
        svg.appendChild(mkT(x,pT+pH+16,l+'',{'text-anchor':'middle',fill:'#ddd','font-size':'10','font-weight':'bold'}));
    }

    // GOLD LINE
    if(pctPts.length>1){
        var pathD='M '+pctPts[0].x+' '+pctPts[0].y;
        for(var pi=1;pi<pctPts.length;pi++)pathD+=' L '+pctPts[pi].x+' '+pctPts[pi].y;
        svg.appendChild(mkE('path',{d:pathD,fill:'none',stroke:'#ffd700','stroke-width':'2.5',opacity:'0.9'}));
    }

    // Gold dots + labels with collision avoidance
    // Track occupied Y zones per column to avoid overlap
    var lastLabelY = -100; // track last label Y to avoid vertical stacking

    for(var pi=0;pi<pctPts.length;pi++){
        var pp=pctPts[pi];
        var dotColor=pp.isZero?'#ff4444':'#ffd700';
        var dotR=pp.isZero?'5':'4';
        svg.appendChild(mkE('circle',{cx:pp.x,cy:pp.y,r:dotR,fill:dotColor,stroke:'#000','stroke-width':'1'}));

        // Label placement with collision avoidance
        var labelText, labelColor, labelSize, labelFont;
        if(pp.isZero){
            labelText='0%'; labelColor='#ff4444'; labelSize='9'; labelFont='Orbitron';
        } else {
            labelText=pp.val.toFixed(0)+'%'; labelColor='#ffd700'; labelSize='8'; labelFont='Roboto Mono';
        }

        // Default: above the dot
        var labelY = pp.y - 10;

        // If too close to top of chart, put below
        if(labelY < pT + 5) labelY = pp.y + 14;

        // If too close to previous label, offset further
        if(Math.abs(labelY - lastLabelY) < 12){
            // Try below dot instead
            labelY = pp.y + 14;
            // If still collides, alternate above/below
            if(Math.abs(labelY - lastLabelY) < 12){
                labelY = pp.y - 18;
            }
        }

        // If near the bottom (0% zone) and multiple points stack, use alternating above/below
        if(pp.y > yBot - 30){
            labelY = pp.y - 12 - (pi % 2) * 14;
        }

        svg.appendChild(mkT(pp.x,labelY,labelText,{'text-anchor':'middle',fill:labelColor,'font-size':labelSize,'font-weight':'bold','font-family':labelFont}));
        lastLabelY = labelY;
    }

    // "NOVELTY PREVAILS" annotation at the last zero point
    var lastZero = null;
    for(var pi=pctPts.length-1;pi>=0;pi--){
        if(pctPts[pi].isZero){lastZero=pctPts[pi];break;}
    }
    if(lastZero){
        // Draw a callout above the zero point
        var cx=lastZero.x, cy=lastZero.y;
        var boxW=130, boxH=20, boxY=cy-40;
        if(boxY < pT+5) boxY = cy + 20;
        svg.appendChild(mkE('rect',{x:cx-boxW/2,y:boxY,width:boxW,height:boxH,rx:4,fill:'rgba(255,68,68,0.15)',stroke:'#ff4444','stroke-width':'1'}));
        svg.appendChild(mkT(cx,boxY+14,'NOVELTY PREVAILS',{'text-anchor':'middle',fill:'#ff4444','font-size':'8','font-weight':'bold','font-family':'Orbitron'}));
        // Connector line
        svg.appendChild(mkE('line',{x1:cx,y1:boxY+boxH,x2:cx,y2:cy-6,stroke:'#ff444466','stroke-width':'1','stroke-dasharray':'2 2'}));
    }

    // Legend
    var lx=pL+10,ly=pT+6;
    svg.appendChild(mkE('rect',{x:lx-4,y:ly-4,width:350,height:50,rx:4,fill:'rgba(5,5,8,0.92)',stroke:'#333','stroke-width':'0.5'}));
    svg.appendChild(mkE('rect',{x:lx,y:ly+2,width:12,height:8,fill:'#00ff88',rx:'1'}));
    svg.appendChild(mkT(lx+18,ly+10,'Real data (left axis)',{fill:'#00ff88','font-size':'8','font-weight':'bold'}));
    svg.appendChild(mkE('rect',{x:lx+160,y:ly+2,width:12,height:8,fill:'none',stroke:'#ff4444','stroke-width':'2','stroke-dasharray':'3 1',rx:'1'}));
    svg.appendChild(mkT(lx+178,ly+10,'50% baseline (from L3)',{fill:'#ff4444','font-size':'8'}));
    svg.appendChild(mkE('line',{x1:lx,y1:ly+24,x2:lx+12,y2:ly+24,stroke:'#ffd700','stroke-width':'2'}));
    svg.appendChild(mkE('circle',{cx:lx+6,cy:ly+24,r:'3',fill:'#ffd700'}));
    svg.appendChild(mkT(lx+18,ly+27,'% of previous (right axis)',{fill:'#ffd700','font-size':'8'}));
    svg.appendChild(mkE('circle',{cx:lx+166,cy:ly+24,r:'4',fill:'#ff4444'}));
    svg.appendChild(mkT(lx+178,ly+27,'0% = novelty prevails',{fill:'#ff4444','font-size':'8','font-weight':'bold'}));

    c.appendChild(svg);
}

// ============================================================
// PCT DIFF CHART
// ============================================================
function renderPctDiff(a){var c=$('pctDiffChart');c.innerHTML='';var pd=a.pct_diff_real_vs_random||{};
var ls=[];for(var l=2;l<=25;l++)if(pd[l]!=null)ls.push(l);
if(!ls.length){c.innerHTML='<div style="color:#666;padding:30px;text-align:center">No data</div>';return;}
var W=920,H=340,pL=65,pR=30,pT=40,pB=55,pW=W-pL-pR,pH=H-pT-pB;var svg=mkS(W,H);
svg.appendChild(mkT(W/2,20,'% DIFFERENCE: Real vs Random',{fill:'#ffd700','font-family':'Orbitron','font-size':'10','text-anchor':'middle'}));
var vs=ls.map(function(l){return pd[l];}),am=Math.max(10,Math.max.apply(null,vs.map(Math.abs)));
am=am<=10?10:am<=25?25:am<=50?50:am<=100?100:Math.ceil(am/50)*50;
function xP(i){return pL+((i+0.5)/ls.length)*pW;}function yP(v){return pT+pH/2-(v/am)*(pH/2);}var y0=yP(0);
svg.appendChild(mkE('line',{x1:pL,y1:y0,x2:pL+pW,y2:y0,stroke:'#ffd700','stroke-width':'1.5','stroke-dasharray':'6 3'}));
svg.appendChild(mkT(pL-6,yP(am)+3,'+'+am+'%',{'text-anchor':'end',fill:'#444','font-size':'8'}));
svg.appendChild(mkT(pL-6,yP(-am)+3,'-'+am+'%',{'text-anchor':'end',fill:'#444','font-size':'8'}));
svg.appendChild(mkT(pL-6,y0+3,'0%',{'text-anchor':'end',fill:'#ffd700','font-size':'8'}));
svg.appendChild(mkT(pL+pW/2,H-8,'Stasis Pattern Length',{'text-anchor':'middle',fill:'#aaa','font-size':'10'}));
var bW=Math.max(10,Math.min(32,pW/ls.length*0.55));
for(var bi=0;bi<ls.length;bi++){var v=vs[bi],bx=xP(bi)-bW/2,cl=v>=0?'#00ff88':'#ff4444';
var bt=v>=0?yP(v):y0,bh=Math.abs(yP(v)-y0),op=Math.min(0.95,0.4+Math.abs(v)/am*0.55);
svg.appendChild(mkE('rect',{x:bx,y:bt,width:bW,height:Math.max(bh,1),fill:cl,opacity:op+'',rx:'3'}));
svg.appendChild(mkT(xP(bi),v>=0?bt-5:bt+bh+11,(v>=0?'+':'')+v.toFixed(1)+'%',{'text-anchor':'middle',fill:cl,'font-size':'8','font-weight':'bold','font-family':'Orbitron'}));
svg.appendChild(mkT(xP(bi),pT+pH+14,ls[bi]+'',{'text-anchor':'middle',fill:'#ddd','font-size':'10','font-weight':'bold'}));}
c.appendChild(svg);}

// ============================================================
// ALPHA CHART
// ============================================================
function renderAlpha(a){var c=$('alphaChart');c.innerHTML='';var al=a.alpha_per_length||{};
var ls=[];for(var l=2;l<=25;l++)if(al[l]!=null)ls.push(l);
if(!ls.length){c.innerHTML='<div style="color:#666;padding:30px;text-align:center">No data</div>';return;}
var W=920,H=320,pL=60,pR=30,pT=40,pB=55,pW=W-pL-pR,pH=H-pT-pB;var svg=mkS(W,H);
svg.appendChild(mkT(W/2,20,'ALPHA: Std Devs from Random',{fill:'#ffd700','font-family':'Orbitron','font-size':'10','text-anchor':'middle'}));
var vs=ls.map(function(l){return al[l];}),am=Math.max(4,Math.max.apply(null,vs.map(Math.abs)))*1.15;
function xP(i){return pL+((i+0.5)/ls.length)*pW;}function yP(v){return pT+pH/2-(v/am)*(pH/2);}
var y0=yP(0),y2p=yP(2),y2n=yP(-2);
if(y2p>=pT&&y2n<=pT+pH){svg.appendChild(mkE('rect',{x:pL,y:y2p,width:pW,height:y2n-y2p,fill:'rgba(255,215,0,0.05)'}));
svg.appendChild(mkE('line',{x1:pL,y1:y2p,x2:pL+pW,y2:y2p,stroke:'#ffd700','stroke-width':'1','stroke-dasharray':'4 3'}));
svg.appendChild(mkE('line',{x1:pL,y1:y2n,x2:pL+pW,y2:y2n,stroke:'#ffd700','stroke-width':'1','stroke-dasharray':'4 3'}));
svg.appendChild(mkT(pL+pW+4,y2p+3,'+2s',{fill:'#ffd700','font-size':'8'}));svg.appendChild(mkT(pL+pW+4,y2n+3,'-2s',{fill:'#ffd700','font-size':'8'}));}
svg.appendChild(mkE('line',{x1:pL,y1:y0,x2:pL+pW,y2:y0,stroke:'#555','stroke-width':'1'}));
var bW=Math.max(10,Math.min(28,pW/ls.length*0.5));
for(var bi=0;bi<ls.length;bi++){var v=vs[bi],bx=xP(bi)-bW/2,cl=v>=0?'#00ff88':'#ff4444',op=Math.abs(v)>=2?'0.95':'0.45';
var bt=v>=0?yP(v):y0,bh=Math.abs(yP(v)-y0);
svg.appendChild(mkE('rect',{x:bx,y:bt,width:bW,height:Math.max(bh,1),fill:cl,opacity:op,rx:'3'}));
svg.appendChild(mkT(xP(bi),v>=0?bt-5:bt+bh+11,(v>=0?'+':'')+v.toFixed(1)+'s',{'text-anchor':'middle',fill:cl,'font-size':'8','font-weight':'bold'}));
svg.appendChild(mkT(xP(bi),pT+pH+14,ls[bi]+'',{'text-anchor':'middle',fill:'#ddd','font-size':'10'}));}
c.appendChild(svg);}

// ============================================================
// TABLES
// ============================================================
function renderFileT(data){var c=$('fileTable'),iv=data.individual_results||[];if(!iv.length){c.innerHTML='';return;}
var h='<table class="stbl"><thead><tr><th>FILE</th><th>SYM</th><th>PRICES</th><th>BITS</th><th>ALT%</th><th>DEV</th><th>%DIFF</th><th>P</th><th>VERDICT</th></tr></thead><tbody>';
for(var i=0;i<iv.length;i++){var r=iv[i];if(r.error)continue;var fn=(r.filename||'?');if(fn.length>20)fn=fn.substring(0,17)+'...';
var d=r.deviation_pct||0,op=r.overall_pct_diff||0,p=r.p_value!=null?r.p_value:1;
h+='<tr><td title="'+(r.filename||'')+'">'+fn+'</td><td style="color:var(--cyan)">'+(r.symbol||'?')+'</td><td>'+(r.n_prices||0).toLocaleString()+'</td><td>'+(r.unified_bits||0).toLocaleString()+'</td><td>'+((r.alternation_rate||0.5)*100).toFixed(2)+'%</td><td class="'+(Math.abs(d)>0.5?(d>0?'sg':'sr'):'')+'">'+(d>0?'+':'')+d.toFixed(3)+'%</td><td class="'+(Math.abs(op)>5?(op>0?'sg':'sr'):'')+'" style="font-weight:bold">'+(op>0?'+':'')+op.toFixed(1)+'%</td><td class="'+(r.is_significant?'sg':'')+'">'+(p<0.0001?p.toExponential(1):p.toFixed(4))+'</td><td class="'+(r.is_significant?'sg':'sw')+'">'+(r.verdict||'?')+'</td></tr>';}
h+='</tbody></table>';c.innerHTML=h;}

function renderRawT(a){var c=$('rawTable'),rd=a.real_distribution||{},db=a.decay_baseline||{},dp=a.decay_pct||{},ex=a.excess_real_vs_random||{},pd=a.pct_diff_real_vs_random||{},al=a.alpha_per_length||{};
var ls=[];for(var l=2;l<=30;l++)if(rd[l]!==undefined)ls.push(l);if(!ls.length){c.innerHTML='';return;}
var h='<table class="stbl"><thead><tr><th>LEN</th><th>REAL</th><th>50% BASE</th><th>% OF PREV</th><th>EXCESS</th><th>% DIFF</th><th>ALPHA</th><th>STATUS</th></tr></thead><tbody>';
for(var i=0;i<ls.length;i++){var l=ls[i],rv=rd[l]||0,bv=db[l],pv=dp[l],ev=ex[l]||0,pdv=pd[l],av=al[l];
var status=rv===0?'<span style="color:#ff4444;font-weight:bold">NOVELTY PREVAILS</span>':pdv==null?'-':pdv>20?'STRONG EXCESS':pdv>5?'EXCESS':pdv>1?'SLIGHT EXCESS':pdv>-1?'NEAR RANDOM':pdv>-5?'SLIGHT DEFICIT':'DEFICIT';
var pc=(pv!=null&&pv===0)?'color:#ff4444;font-weight:bold':'color:#ffd700;font-weight:bold';
var pl=pv!=null?pv.toFixed(1)+'%':'-';if(pv===0)pl='0% !';
h+='<tr><td style="font-weight:bold;color:var(--cyan)">'+l+'</td><td style="color:'+(rv>0?'#00ff88':'#ff4444')+';font-weight:bold">'+rv.toLocaleString()+'</td><td style="color:#ff4444">'+(bv!=null&&l>=3?bv.toFixed(1):'-')+'</td><td style="'+pc+'">'+pl+'</td><td class="'+(ev>0?'sg':ev<0?'sr':'')+'">'+(ev>0?'+':'')+(typeof ev==='number'?ev.toFixed(1):ev)+'</td><td class="'+(pdv!=null&&pdv>5?'sg':pdv!=null&&pdv<-5?'sr':'')+'" style="font-weight:bold">'+(pdv!=null?(pdv>0?'+':'')+pdv.toFixed(1)+'%':'-')+'</td><td class="'+(av!=null&&Math.abs(av)>=2?(av>0?'sg':'sr'):'')+'">'+(av!=null?(av>0?'+':'')+av.toFixed(1)+'s':'-')+'</td><td>'+status+'</td></tr>';}
h+='</tbody></table>';c.innerHTML=h;}

document.addEventListener('DOMContentLoaded',function(){
var obs=new IntersectionObserver(function(es){es.forEach(function(e){if(e.isIntersecting)e.target.classList.add('vis');});},{threshold:0.1});
document.querySelectorAll('.fi').forEach(function(el){obs.observe(el);});
fetch('/health').then(function(r){if(r.ok)setStat('Server connected. Upload files to begin.','#00ff88');else setStat('Server issue','#ff4444');}).catch(function(){setStat('Cannot reach server','#ff4444');});});
</script>
</body>
</html>